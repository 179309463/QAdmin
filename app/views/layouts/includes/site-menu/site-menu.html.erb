<%= render file: "layouts/includes/site-menu/#{@theme}/index" %>

<script>
/**
 * QAdmin v1.2.0 (http://www.qadmin.com/)
 * Copyright 2015-2017 QAdmin Team
 * Licensed under the QAdmin License 1.0 (http://www.qadmin.com/about/#license)
 */
(function (window, document, $) {
	'use strict';
	
	$.site.menu = $.site.menu || {
		speed: 250,
		accordion: true, // 将默认的折叠效果改为手风琴效果
		
		init: function () {
			this.$instance = $('.site-menu');
			
			if (this.$instance.length === 0) {
			    return;
            }
			
			this.bind();
		},
		
		bind: function () {
			var self = this;

			this.$instance.on('mouseenter.site.menu', '.site-menu-item', function () {
				var $item = $(this);
				
				if ($.site.menubar.folded === true && $item.is('.has-sub') && $item.parent('.site-menu').length > 0) {
					//self.position($item, $item.children('.site-menu-sub'));
                    $('body').addClass('site-menubar-fold-hover');
				}
				
				$item.addClass('hover');
			}).on('mouseleave.site.menu', '.site-menu-item', function () {
				var $item = $(this);
				if ($.site.menubar.folded === true && $item.is('.has-sub') && $item.parent('.site-menu').length > 0) {
					$item.children('.site-menu-sub');//.css("max-height", "");
                    $('body').removeClass('site-menubar-fold-hover');
				}
				
				$item.removeClass('hover');
			}).on('deactive.site.menu', '.site-menu-item.active', function (e) {
				var $item = $(this);
				
				$item.removeClass('active');
				
				e.stopPropagation();
			}).on('active.site.menu', '.site-menu-item', function (e) {
				var $item = $(this);
				
				$item.addClass('active');
				
				e.stopPropagation();
			}).on('open.site.menu', '.site-menu-item', function (e) {
				var $item = $(this);
				
				self.expand($item, function () {
					$item.addClass('open');
				});
				
				if (self.accordion) {
					$item.siblings('.open').trigger('close.site.menu');
				}
				
				e.stopPropagation();
			}).on('close.site.menu', '.site-menu-item.open', function (e) {
				var $item = $(this);
				
				self.collapse($item, function () {
					$item.removeClass('open');
				});
				
				e.stopPropagation();
			}).on('click.site.menu ', '.site-menu-item>a', function () {
				var $parent = $(this).parent();
				
				if ($parent.is('.has-sub')) {
					if ($parent.is('.open')) {
						$parent.trigger('close.site.menu');
					} else {
						$parent.trigger('open.site.menu');
					}
				} else {
					self.$instance.find('li.active').trigger('deactive.site.menu');
					$parent.trigger('active.site.menu');
					
				}
			}).on('tap.site.menu', '> .site-menu-item > a', function () {
				var link = $(this).attr('href');
				
				if (link && ($(this).data("pjax")==undefined)) {
					window.location = link;
				}
			}).on('touchend.site.menu', '> .site-menu-item > a', function () {
				var $item = $(this).parent('.site-menu-item');
				
				if (!$.site.menubar.folded) {
					return;
				}

                if ($item.is('.has-sub') && $item.parent('.site-menu').length > 0) {
                    $item.siblings('.hover').removeClass('hover');

                    if ($item.is('.hover')) {
                        $item.removeClass('hover');
                    } else {
                        $item.addClass('hover');
                    }
                }
			}).on('scroll.site.menu', '.site-menu-sub', function (e) {
				e.stopPropagation();
			});
			
		},
		
		collapse: function ($item, callback) { // 菜单的子级菜单的折叠动作
			var self = this;
			var $sub = $item.children('.site-menu-sub');
			
			$sub.show().slideUp(this.speed, function () {
				$(this).css('display', '');
				
				$(this).find('> .site-menu-item').removeClass('is-shown');
				
				if (callback) {
					callback();
				}
				
				self.$instance.trigger('collapsed.site.menu');
			});
		},
		
		expand: function ($item, callback) { // 菜单的子级菜单的展开动作
			var self = this,
				$sub = $item.children('.site-menu-sub'),
				$children = $sub.children('.site-menu-item').addClass('is-hidden');
			
			$sub.hide().slideDown(this.speed, function () {
				$(this).css('display', '');
				
				if (callback) {
					callback();
				}
				
				self.$instance.trigger('expanded.site.menu');
			});
			
			setTimeout(function () {
				$children.addClass('is-shown');
				$children.removeClass('is-hidden');
			}, 0);
		},
		
		refresh: function () { // 折叠未选中的左侧系统菜单
			this.$instance.find('.open').filter(':not(.active)').removeClass('open');
		},
		
		position: function ($item, $dropdown) { // 窗口 | 在小屏幕设备上，左侧系统菜单的下拉列表的位置操作功能
			var offsetTop = $item.position().top,
				menubarHeight = $.site.menubar.$instance.outerHeight(),
				itemHeight = $item.find("> a").outerHeight();
			
			//$dropdown.removeClass('site-menu-sub-up');//.css('max-height', "");
			
			// if (offsetTop > menubarHeight / 2) {
			// 	//$dropdown.addClass('site-menu-sub-up');
				
			// 	if ($.site.menubar.foldAlt) {
			// 		offsetTop = offsetTop - itemHeight;
			// 	}
			// 	//$dropdown.css('max-height', offsetTop + itemHeight);
			// } else {
			// 	if ($.site.menubar.foldAlt) {
			// 		offsetTop = offsetTop + itemHeight;
			// 	}
			// 	//$dropdown.removeClass('site-menu-sub-up');
			// 	//$dropdown.css('max-height', menubarHeight - offsetTop);
			// }
		}
	};
})(window, document, jQuery);

/**
 * QAdmin v1.2.0 (http://www.qadmin.com/)
 * Copyright 2015-2017 QAdmin Team
 * Licensed under the QAdmin License 1.0 (http://www.qadmin.com/about/#license)
 */
(function (window, document, $) {
    'use strict';

    var $body = $('body'),
        $html = $('html');

    $.site.menubar = $.site.menubar || {
        opened: null,
        folded: null,
        top: false,
        foldAlt: false,
        $instance: null,
        auto: true,

        init: function () {
            var self = this;

            $html.removeClass('css-menubar').addClass('js-menubar');

            this.$instance = $("#qadmin-navTabs");
            this.tagId = $('.nav-tabs li.active > a').attr('href');

            if(this.tagId === '#'){
                this.tagId = $('.nav-tabs li.active').find('ul>li.active>a').attr('href');
            }

            if (this.$instance.length === 0) {
                return;
            }

            // 鼠标经过左侧菜单显示图标
            if ($body.is('.site-menubar-fold-alt')) {
                this.foldAlt = true;
            }

            // 鼠标经过左侧菜单显示文字
            if ($body.is('.site-menubar-keep')) {
                if ($body.hasClass('site-menubar-fold')) { // 收起
                    this.auto = 'fold';
                } else if ($body.hasClass('site-menubar-unfold')) { //展开
                    this.auto = 'unfold';
                }
            }

            this.$instance.on('changed.site.menubar', function () {
                self.update();
            });

            $('.nav-tabs li:not(.no-menu)').on('shown.bs.tab', function (event) {
                var tagId = self.tagId = $(event.target).attr('href');
                if ($body.hasClass('site-menubar-fold')) {
                    self.hoverscroll.enable(tagId);
                } else if ($body.hasClass('site-menubar-unfold')) {
                    self.slimScroll.enable();
                }
            });

            this.change();
        },

        change: function () {
            var breakpoint = Breakpoints.current();

            if (this.auto !== true) {
                switch (this.auto) {
                    case 'fold':
                        this.reset();
                        if (breakpoint.name === 'xs') {
                            this.hide();
                        } else {
                            this.fold();
                        }
                        return;
                    case 'unfold':
                        this.reset();
                        if (breakpoint.name === 'xs') {
                            this.hide();
                        } else {
                            this.unfold();
                        }
                        return;
                }
            }

            this.reset();

            if (breakpoint) {
                switch (breakpoint.name) {
                    case 'lg':
                        this.unfold();
                        break;
                    case 'md':
                    case 'sm':
                        this.fold();
                        break;
                    case 'xs':
                        this.hide();
                        break;
                }
            }
            Breakpoints.on('xs', 'leave', function () {
                $('#qadmin-navMenu').responsiveHorizontalTabs({
                    tabParentSelector: '#qadmin-navTabs',
                    fnCallback: function (el) {
                        if ($('#qadmin-navMenu').is(':visible')) {
                            el.removeClass('is-load');
                        }
                    }
                });
            });
        },

        animate: function (doing, callback) {
            var self = this;
            $body.addClass('site-menubar-changing');

            doing.call(self);
            this.$instance.trigger('changing.site.menubar');

            callback.call(self);
            $body.removeClass('site-menubar-changing');

            self.$instance.trigger('changed.site.menubar');
        },

        reset: function () {
            this.opened = null;
            this.folded = null;
            $body.removeClass('site-menubar-hide site-menubar-open site-menubar-fold site-menubar-unfold');
            $html.removeClass('disable-scrolling');
        },

        open: function () {
            if (this.opened !== true) {
                this.animate(function () {
                    $body.removeClass('site-menubar-hide').addClass('site-menubar-open site-menubar-unfold');
                    this.opened = true;

                    $html.addClass('disable-scrolling');

                }, function () {
                    this.slimScroll.enable();
                });
            }
        },

        hide: function () {
            this.hoverscroll.disable();

            if (this.opened !== false) {
                this.animate(function () {

                    $html.removeClass('disable-scrolling');
                    $body.removeClass('site-menubar-open').addClass('site-menubar-hide site-menubar-unfold');
                    this.opened = false;

                }, function () {
                    this.slimScroll.enable();
                });
            }
        },

        unfold: function () {
            this.hoverscroll.disable();

            if (this.folded !== false) {
                this.animate(function () {
                    $body.removeClass('site-menubar-fold').addClass('site-menubar-unfold');
                    this.folded = false;

                }, function () {
                    this.slimScroll.enable();
                });
            }
        },

        fold: function () {
            this.slimScroll.destroy();

            if (this.folded !== true) {
                this.animate(function () {
                    $body.removeClass('site-menubar-unfold').addClass('site-menubar-fold');
                    this.folded = true;

                }, function () {
                    this.hoverscroll.enable(this.tagId);
                });
            }
        },

        toggle: function () {
            var breakpoint = Breakpoints.current(),
                folded = this.folded,
                opened = this.opened;

            switch (breakpoint.name) {
                case 'lg':
                    if (folded === null || folded === false) {
                        this.fold();
                    } else {
                        this.unfold();
                    }
                    break;
                case 'md':
                case 'sm':
                    if (folded === null || folded === true) {
                        this.unfold();
                    } else {
                        this.fold();
                    }

                    $('#qadmin-navMenu').responsiveHorizontalTabs({
                        tabParentSelector: '#qadmin-navTabs'
                    });
                    break;
                case 'xs':
                    if (opened === null || opened === false) {
                        this.open();
                    } else {
                        this.hide();
                    }
                    break;
            }
        },

        update: function () {
            this.hoverscroll.update();
        },

        slimScroll: {
            api: null,
            native: false,
            init: function () {
                // if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                //   this.native = true;
                //   $body.addClass('site-menubar-native');
                //   return;
                // }

                if ($body.is('.site-menubar-native')) {
                    this.native = true;
                    return;
                }

                $.site.menubar.$instance.slimScroll($.po('slimScroll'));
            },

            enable: function () {
                if (this.native) {
                    return;
                }
                this.init();
            },

            destroy: function () {
                $.site.menubar.$instance.slimScroll({destroy: true});
                $.site.menubar.$instance.removeAttr('style');
            }
        },

        hoverscroll: {
            api: null,

            init: function (tagId) {
                $.site.menubar.$instance.find(tagId).children('div').attr('style', '');
                this.api = $.site.menubar.$instance.find(tagId).asHoverScroll({
                    namespace: 'hoverscorll',
                    direction: 'vertical',
                    list: '.site-menu',
                    item: '> li',
                    exception: '.site-menu-sub',
                    fixed: false,
                    boundary: 100,
                    onEnter: function () {
                        //$(this).siblings().removeClass('hover');
                        //$(this).addClass('hover');
                    },
                    onLeave: function () {
                        //$(this).removeClass('hover');
                    }
                }).data('asHoverScroll');
            },

            update: function () {
                if (this.api) {
                    this.api.update();
                }
            },

            enable: function (tagId) {
                if (tagId !== this.tagId) {
                    this.tagId = tagId;
                    this.init(tagId);
                } else {
                    if (this.api) {
                        this.api.enable();
                    }
                }
            },

            disable: function () {
                if (this.api) {
                    this.api.disable();
                }
            }
        }
    };
})(window, document, jQuery);
</script>